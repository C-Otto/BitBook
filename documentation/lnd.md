# lnd Support
BitBook has basic support for [lnd (lightning network daemon)](https://github.com/lightningnetwork/lnd) so that you can
add ownership information and helpful descriptions for transactions/addresses managed by your lnd instance without
entering these manually.

This is implemented by parsing JSON files generated by the `lncli` command line tool. As such, this involves a bit of
manual effort, but it also keeps things simple. By copying these files you can easily use BitBook and lnd on
different computers. Furthermore, by not giving BitBook access to lnd, there's no risk of undesired side effects.

### Unspent Outputs
Using `lncli listunspent` you can get a list of all unspent outputs managed by lnd.
As such, BitBook should mark these addresses as owned (with the description "lnd").
You can do this using the command `lnd-add-from-unspent-outputs`:

1. first create the JSON file using lnd: `$ lncli listunspent > lnd-unspent.json`
2. transfer the JSON file to the host where you are running BitBook: `$ scp server:/home/lnd/lnd-unspent.json /tmp/`
3. start BitBook

Then you can use the command as follows:
```
BitBook$ lnd-add-from-unspent-outputs /tmp/lnd-unspent.json
Marked 6 addresses as owned by lnd
```

### Sweeps
After a channel is closed, your funds (on the "local" side of the channel) are sent to an address that is not derived
from your lnd wallet seed. To avoid loss of funds, lnd automatically "sweeps" those funds to another address. As such,
there may be several sweep transactions that transfer funds from one address to another.

BitBook offers the command `lnd-add-from-sweeps` which parses lnd sweep information and does the following for each
transaction:

 - sets the transaction description to "lnd sweep transaction"
 - sets the source and target addresses descriptions to "lnd"
 - marks both addresses as owned

To run the command:
1. first create the JSON file using lnd: `$ lncli wallet listsweeps > lnd-sweeps.json`
2. transfer the JSON file to the host where you are running BitBook: `$ scp server:/home/lnd/lnd-sweeps.json /tmp/`
3. start BitBook
   
Then you can use the command as follows:
```
BitBook$ lnd-add-from-sweeps /tmp/lnd-sweeps.json
Added information for 86 sweep transactions
```

### Channels
lnd stores information about channels, including references to the opening transaction and whether you opened the
channel.

BitBook offers the command `lnd-add-from-channels` which parses this information and

- marks the channel address as owned if you opened the channel, or as foreign if the remote opened the channel
- sets the channel address description to "Lightning-Channel with <pubkey>"
- sets the description to "Opening Channel with <pubkey> (<type>)"
  - type is one out of "local" or "remote"

Notes:

- If your lnd node has channels to another node you own, setting ownership of the address belonging to the remote
  node as *foreign* may be wrong. To avoid this, for addresses already marked as *owned* the ownership is not changed.
- If a transaction opens more than one channel, only one of these is mentioned in the description.

To run the command:
1. first create the JSON file using lnd: `$ lncli listchannels > lnd-channels.json`
2. transfer the JSON file to the host where you are running BitBook: `$ scp server:/home/lnd/lnd-channels.json /tmp/`
3. start BitBook

Then you can use the command as follows:
```
BitBook$ lnd-add-from-channels /tmp/lnd-channels.json
Added information for 67 channels
```

### Closed Channels
lnd stores information about closed channels, including references to the opening and closing transactions.
This record also includes information about the value returned to your own wallet.

BitBook offers the command `lnd-add-from-closed-channels` which parses this information and

- marks the channel address (input of closing transaction) as owned if you opened the channel,
  or as foreign if the remote opened the channel
- for the closing transaction:
  - sets the description to "Closing Channel with <pubkey> (<type>)"
    - type is one out of "cooperative", "cooperative local", "cooperative remote", "force local", "force remote"
  - sets the input address description to "Lightning-Channel with <pubkey>"
  - for addresses which are used to return channel funds, marks these as owned
  - handles sweep transactions mentioned in HTLC resolutions (see [Sweeps](#sweeps))
- for the opening transaction:
  - sets the description to "Opening Channel with <pubkey> (<type>)"
    - type is one out of "local", "remote", "unknown"
  
Notes:

- If your lnd node has/had channels to another node you own, setting ownership of the address belonging to the remote
  node as *foreign* may be wrong. To avoid this, for addresses already marked as *owned* the ownership is not changed.
- If a transaction opens more than one channel, only one of these is mentioned in the description.

To run the command:
1. first create the JSON file using lnd: `$ lncli closedchannels > lnd-closedchannels.json`
2. transfer the JSON file to the host where you are running BitBook: `$ scp server:/home/lnd/lnd-closedchannels.json /tmp/`
3. start BitBook

Then you can use the command as follows:
```
BitBook$ lnd-add-from-closed-channels /tmp/lnd-closedchannels.json
Added information for 99 channels
```

### On-Chain Transactions
lnd keeps a record of all on-chain transactions, which includes regular transactions from/to lnd's wallet, and channel
opening transactions. You can make use of this information by using the command `lnd-add-from-onchain-transactions`.

Currently, the following transaction types are supported:

#### Funding Transactions
For transactions that send funds to lnd's wallet, the target address is marked as owned.
Furthermore, the description "lnd" is added.

To run the command:
1. first create the JSON file using lnd: `$ lncli listchaintxns > lnd-onchain-transactions.json`
2. transfer the JSON file to the host where you are running BitBook: `$ scp server:/home/lnd/lnd-onchain-transactions.json /tmp/`
3. start BitBook

Then you can use the command as follows:
```
BitBook$ lnd-add-from-onchain-transactions /tmp/lnd-onchain-transactions.json
Added information from 671 transactions
```